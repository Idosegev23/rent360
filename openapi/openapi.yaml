openapi: 3.1.0
info:
  title: Rentals & Leads API
  version: 1.0.0
servers:
  - url: https://api.your-domain.com/v1
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200': { description: OK }
  /leads:
    post:
      summary: Upsert lead
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadInput'
      responses:
        '200': { description: Updated }
        '201': { description: Created }
        '422': { description: Validation error }
  /properties:
    post:
      summary: Upsert property
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PropertyInput'
      responses:
        '200': { description: Updated }
        '201': { description: Created }
  /webhooks/leads-ingest:
    post:
      summary: Ingest lead from external system (LeadMeCMS)
      description: |
        Webhook לקליטת לידים ממערכות צד ג'.
        אימות באמצעות `Authorization: Bearer <token>`.
        תומך ב-`application/json` וגם `application/x-www-form-urlencoded`.
      parameters:
        - in: header
          name: Authorization
          required: true
          description: Bearer token
          schema:
            type: string
        - in: header
          name: Idempotency-Key
          required: false
          description: Optional idempotency key to dedupe identical retries
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadMeCMSPayload'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/LeadMeCMSPayload'
      responses:
        '201': { description: Created }
        '200': { description: Upserted (duplicate by phone) }
        '401': { description: Unauthorized }
        '422': { description: Validation error }
components:
  schemas:
    LeadInput:
      type: object
      required: [source_id, phone]
      properties:
        external_id: { type: string }
        source_id: { type: string }
        full_name: { type: string }
        phone: { type: string, description: E.164 }
        email: { type: string }
        budget_min: { type: integer }
        budget_max: { type: integer }
        preferred_cities: { type: array, items: { type: string } }
        preferred_rooms: { type: integer }
        must_haves: { type: object }
        nice_to_haves: { type: object }
        move_in_from: { type: string, format: date }
        notes: { type: string }
    PropertyInput:
      type: object
      required: [source_id, title, city, price]
      properties:
        external_id: { type: string }
        source_id: { type: string }
        title: { type: string }
        city: { type: string }
        neighborhood: { type: string }
        address: { type: string }
        price: { type: integer }
        rooms: { type: integer }
        sqm: { type: integer }
        amenities: { type: object }
        available_from: { type: string, format: date }
        link: { type: string }
        images: { type: array, items: { type: object } }
        is_active: { type: boolean }
    LeadMeCMSPayload:
      type: object
      description: Payload fields as configured in LeadMeCMS outbound integration
      required: [phone]
      properties:
        First_name: { type: string }
        Last_name: { type: string }
        phone: { type: string, description: Raw phone, will be normalized to E.164 }
        email: { type: string }
        city_lives: { type: string, description: Preferred city }
        rooms: { type: string, description: Preferred rooms (number), may be numeric string }
        price_range: { type: string, description: "e.g. '2500-15000' or '2500 – 15000'" }
        Elevator: { type: string, description: yes/no or boolean-like }
        Mamad: { type: string, description: safe room requirement yes/no }
        balcony: { type: string }
        AC: { type: string }
        warehouse: { type: string }
        type_asset: { type: string, description: Desired asset type }
        apt: { type: string, description: Notes or apartment details }
